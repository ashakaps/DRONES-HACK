# DRONES_HACK

## Краткое описание

Сервис, который будет автоматически обрабатывать статистические данные Росавиации и извлекать из них показатели по количеству и длительности полётов гражданских беспилотников в каждом регионе. Эти показатели помогут определить регионы-лидеры по использованию беспилотных систем.

Задача сервиса – сокращение трудозатрат государственных учреждений на формирование отчетов по полетам БАС (беспилотных авиационных системы) и производимым работам в регионе.

Решение - отдельный сервис, который может стать независимой информационной системой или ее компонентом. Сервис должен работать на операционной системе семейства Linux

## Функциональные возможности

- **Очистка, нормализация и расчёт метрик**.  Предобработчик (*src/prepoc.py*) извлекает из Excel‑файлов идентификаторы полётов, времена вылета/прилёта, координаты взлёта и посадки, вычисляет длительность (в минутах), дистанцию по формуле хаверсина, среднюю скорость и относительную загруженность региона.  Данные обогащаются погодными параметрами, классифицируются по сезонам и времени суток и загружаются в PostgreSQL/PostGIS.
- **REST‑API для геоданных и статистики**.  Сервис предоставляет точки `/geo/regions` и `/geo/cities` для выдачи границ регионов и координат городов в формате GeoJSON, `/charts/{name}` — для генерации графиков (топ‑10 регионов, ежемесячная динамика, еженедельная динамика по выбранному городу), `/charts/report_json` — для получения тех же данных в виде JSON.  Метаданные и состояние базы доступны через `/db/status` и `/db/flight_count`.
- **Загрузка новых данных**.  Администратор может импортировать новые Excel‑файлы с полётами через энд‑точку `/db/upload` (front‑end реализует drag‑and‑drop и индикатор прогресса).  Сервис проверяет расширение и размер (до 100 MB), сохраняет файл во временную папку и запускает фоновую обработку — конвертацию и загрузку в базу данных.  Статус обработки можно запросить через `/db/upload-status/{file_id}`.
- **Ролевой доступ и аутентификация**.  Пользователь входит через форму логина (email + пароль).  Маршрут `/api/auth/login` возвращает JWT‑токен, а `/api/auth/me` — сведения о текущем пользователе.  Два типа ролей:
  - **Администратор** — создаёт/удаляет пользователей, загружает данные, видит таблицу аккаунтов (email, роль, время создания и последнего входа), имеет доступ к карте и профилю.
  - **Оператор** — просматривает карту и свой профиль, не может управлять пользователями и данными.  Проверка токена и ролей реализована в `app/routes/auth.py` и `auth_funcs.py`; для администратора предоставляются end‑point’ы `/api/users` для получения списка, создания и удаления пользователей.
- **Интерактивный фронтенд**.  Новая клиентская часть (`app/frontend`) написана на React и собирается через Vite.  Она включает:
  - **Авторизацию** (AuthContext) — хранение токена в `localStorage`, запрос профиля, редирект на `/login` при отсутствии валидного токена.
  - **Панель администратора** (`Dashboard.jsx`) с вкладками *Пользователи*, *Загрузка данных*, *Карта России* и *Профиль*.  Таблица пользователей позволяет добавлять новые аккаунты и удалять существующие; вкладка загрузки отображает счётчик полётов и позволяет импортировать Excel‑файлы.  Состояние загрузки и прогресса отображается пользователю.
  - **Интерактивная карта** (`DroneRadar.tsx`) на основе Leaflet: фильтры по городу и региону, переключение режимов отображения, всплывающие подсказки и боковые панели для просмотра статистики.  Диаграммы загружаются через API и отображаются в боковых виджетах.
- **Генерация графиков и отчётов**.  Модуль `app/charts/generator.py` строит PNG‑графики по данным из *clean_data.xlsx*: топ‑10 регионов, ежемесячные итоги и еженедельные значения по выбранному городу.  Функция `generate_all_charts` сохраняет изображения в `app/static/data/png` и возвращает пути для фронтенда.  Энд‑точка `/charts/report_json` возвращает те же показатели в формате JSON для последующего анализа.
- **Прочее**.  В репозитории есть заготовка микросервиса ML (`ml/`), который в будущем будет обеспечивать прогнозирование длительности полётов и загруженности, а также скрипты для загрузки географических данных (`database/load_geojson.py`) и заполнения базы (`database/load_all_data.py`).

## Архитектура и взаимодействие компонентов

Сервис реализован в виде набора микросервисов, взаимодействующих по HTTP/REST.  Главный API обслуживает маршруты для аутентификации, работы с пользователями, загрузки данных, генерации графиков и получения геоданных.  Схема взаимодействия показана ниже:

```
┌──────────────┐       HTTP/REST          ┌─────────────────────────────┐
│  Frontend    │◀───────────────────────▶│  API Service (FastAPI)      │
│  (React)     │                          │  • /api/auth/login, /me     │
└──────────────┘                          │  • /api/users (admin)       │
        ▲                                 │  • /db/flight_count         │
        │                                 │  • /db/upload               │
        │                                 │  • /geo/regions, /geo/cities│
        │                                 │  • /charts/{name}, report   │
        │                                 └──────────────▲──────────────┘
        │                                                │
        │                                         asyncpg & SQLModel
        │                                                ▼
┌──────────────┐                          ┌──────────────────────────┐
│  ML Service  │─── HTTP/REST (future) ─▶│  PostGIS Database (DB)    │
│  (FastAPI)   │                          └──────────────────────────┘
└──────────────┘
```

**Backend.**  Файл `app/main.py` инициализирует FastAPI, подключает CORS, включает маршруты для графиков, базы данных, геоданных и авторизации, а также монтирует статические файлы.  При старте создаётся пул соединений с Postgres, а при необходимости создаётся пользователь‑администратор по умолчанию.  Авторизационные функции (`hash_password`, `create_access_token`, `get_current_user`, `require_admin`) определены в `auth_funcs.py`.  Пользователи хранятся в таблице `user` с полями `email`, `role`, `hashed_password`, `created_at` и `last_login_at`.

**Frontend.**  Клиентская часть (`app/frontend`) разработана на React/Vite с использованием React Router и React‑Leaflet.  В `Dockerfile` предусмотрен двухэтапный сборочный процесс: сначала Node‑контейнер собирает фронтенд (`npm ci && npm run build`), затем Python‑контейнер копирует собранные файлы в `app/static`.  Это обеспечивает раздельное развитие UI и бэкенда и упрощает деплой.

## Структура репозитория

| Путь                              | Назначение |
|-----------------------------------|------------|
| `app/main.py`                     | Инициализация FastAPI, CORS, регистрация маршрутов и статических файлов |
| `app/routes/auth.py`              | Энд‑точки авторизации: выдача токена, вход пользователя, получение профиля, управление пользователями (CRUD) |
| `app/routes/db.py`                | Энд‑точки работы с БД: проверка соединения, количество полётов, загрузка файлов и отслеживание статуса загрузки |
| `app/routes/geo.py`               | Выдача границ регионов и городов в формате GeoJSON |
| `app/routes/charts.py`            | Генерация графиков, возвращение путей к изображениям и JSON‑отчётов |
| `app/charts/generator.py`         | Функции построения PNG‑графиков по очищенным данным |
| `app/frontend/src/…`              | Код клиентского приложения на React (авторизация, панель администратора, карта и виджеты) |
| `database/schema_db.sql`          | SQL‑схема PostGIS: таблицы регионов, типов БПЛА, полётов, геолокаций, метрик, погоды и сезонов |
| `database/load_geojson.py`        | Скрипт загрузки гео‑данных (границы регионов и города) в базу |
| `database/load_all_data.py`       | Скрипт построчной загрузки Excel‑данных в Postgres, с дедупликацией и вычислением метрик |
| `ml/`                             | Заготовка микросервиса машинного обучения (FastAPI) |
| `docker-compose.yml`              | Определение сервисов Docker: API, ML, PostGIS.  Настройки CORS и переменных окружения |
| `Dockerfile`                      | Двухэтапный билд: сборка фронтенда на Node и упаковка бэкенда в Python‑образ |

## Требования и зависимости

- **Операционная система:** Linux (Ubuntu 20.04+), macOS или Windows.
- **Python:** 3.10 или выше.
- **Node.js:** ≥ 18 (только для разработки и сборки фронтенда; в Docker это делается автоматически).
- **PostgreSQL:** 13+ с расширением PostGIS.
- **Docker:** рекомендуется для быстрого развёртывания (составляет единую среду для API, ML и базы).

Основные Python‑библиотеки перечислены в `requirements.txt`: `fastapi`, `uvicorn`, `pydantic`, `sqlmodel`, `asyncpg`, `python-jose`, `passlib`, `pandas`, `openpyxl`, `matplotlib`, `seaborn`, `sqlalchemy` и др.  Клиент использует `react`, `react‑router‑dom`, `leaflet` и `axios` (см. `app/frontend/package.json`).

## Установка и запуск

### 1. Запуск через Docker

1. Установите [Docker](https://docs.docker.com/get-docker/) и [Docker Compose](https://docs.docker.com/compose/).
2. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/ashakaps/DRONES_HACK.git
   cd DRONES_HACK
   ```

3. Создайте файл `.env` на основе `.env.example`.  В нём задаются параметры подключения к базе (`DATABASE_URL`), CORS (`CORS_ORIGINS`) и секрет для JWT (`JWT_SECRET`).  Пример:

   ```ini
   DATABASE_URL=postgresql://postgres:postgres@db:5432/droneradar
   JWT_SECRET=supersecretkey
   CORS_ORIGINS=http://localhost:3000,http://localhost:5173
   ```

4. Запустите сборку и поднятие сервисов:

   ```bash
   docker-compose up --build
   ```

   После сборки фронтенда и бэкенда API станет доступно на `http://localhost:8080`.

5. Откройте в браузере `http://localhost:8080`.  Если всё прошло успешно, вы увидите форму авторизации.  В систему уже создан пользователь `admin@example.com` с паролем `admin123`.  После входа откроется панель администратора.  ML‑сервис доступен на порту `8001` (пока реализованы энд‑точки `/ping` и `/predict`).

### 2. Локальный запуск для разработки

1. Установите PostgreSQL с расширением PostGIS и создайте базу `droneradar`.
2. Создайте виртуальное окружение и установите зависимости:

   ```bash
   python3 -m venv venv
   source venv/bin/activate
   pip install --upgrade pip
   pip install -r requirements.txt
   ```

3. Выполните миграции и заполните базу первоначальными данными:

   ```bash
   python database/load_geojson.py --regions data/geojson/regions.json
   python database/load_all_data.py --data_file data/data.xlsx
   ```

4. Для фронтенда перейдите в каталог `app/frontend`, установите зависимости и запустите локальный сервер:

   ```bash
   cd app/frontend
   npm install
   npm run dev
   ```

   Приложение будет доступно на `http://localhost:5173`, запросы к API проксируются (см. `vite.config.*`) к `http://localhost:8080`.

5. Запустите бэкенд отдельно (если не используете Docker):

   ```bash
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8080
   ```

## Примеры использования

### Авторизация и управление пользователями

```bash
# логин администратора (получение токена)
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "admin123"}'
# → {"access_token":"<jwt>", "token_type":"bearer"}

# получение профиля
curl -H "Authorization: Bearer <jwt>" http://localhost:8080/api/auth/me
# → {"id":1,"email":"admin@example.com","role":"admin", …}

# создание пользователя (администратор)
curl -X POST http://localhost:8080/api/users \
  -H "Authorization: Bearer <jwt>" \
  -H "Content-Type: application/json" \
  -d '{"email":"operator@example.com","password":"pass123","role":"operator"}'

# получение списка
curl -H "Authorization: Bearer <jwt>" http://localhost:8080/api/users

# удаление пользователя
curl -X DELETE -H "Authorization: Bearer <jwt>" http://localhost:8080/api/users/2
```

### Загрузка данных

```bash
# узнайте текущее количество полётов в базе
curl http://localhost:8080/db/flight_count
# → {"flight_count":12345}

# загрузка Excel‑файла
curl -X POST http://localhost:8080/db/upload \
  -H "Authorization: Bearer <jwt>" \
  -F "file=@/path/to/flights.xlsx"
# → {"message":"Файл успешно загружен и поставлен в очередь…","file_id":"…"}

# проверка статуса
curl http://localhost:8080/db/upload-status/<file_id>
# → {"file_id":"…","status":"processing","message":"Файл в процессе обработки"}
```

### Получение геоданных и графиков

```bash
# границы всех регионов
curl http://localhost:8080/geo/regions

# 10 крупнейших регионов по количеству полётов
curl http://localhost:8080/charts/top10_regions
# → {"path":"/static/data/png/top10_regions.png"}

# ежемесячный объём
curl http://localhost:8080/charts/monthly_total

# отчёт в JSON
curl "http://localhost:8080/charts/report_json?city=Москва"
# → {"city":"Москва","top10_regions":{…},"monthly_total":{…},"weekly_by_city":{…}}
```

## Планы развития

В ходе хакатона выполнены ключевые задачи: реализованы авторизация и ролевой доступ, импорт данных через веб‑интерфейс и API, обновлены графики, создан современный интерфейс.  Далее планируется:

1. **Расширение аналитики.**  Добавить новые типы диаграмм (распределение по типам БПЛА, тепловые карты времени суток, погодные корреляции), поддержку интерактивных фильтров по дате и погоде.
2. **Интеграция ML‑модуля.**  Разработать модели прогнозирования длительности полётов, выявления аномалий и оценивания потенциала загруженности регионов.  В API появятся энд‑точки `/predict` для получения вероятностных оценок.
3. **Продвинутый импорт и источники данных.**  Поддержать загрузку данных в других форматах (CSV, Parquet), подключить автоматический импорт через API Росавиации, открытые метеосервисы и мониторинг в реальном времени.
4. **Управление пользователями.**  Реализовать изменение пароля и восстановление доступа, подробнее настроить права (например, роль аналитика), добавить аудит действий пользователей.
5. **Улучшение UI/UX.**  Оптимизировать работу React‑интерфейса, обеспечить адаптацию под мобильные устройства, добавить тёмную/светлую темы и экспорт отчётов в PDF.

## Команда

- **ashakaps** — Data Scientist, отвечала предобработку и анализ данных (`preprocessing.py`) в команде с **l00fi**, а также за разработку базы данных, её наполение и оформление документации.
- **l00fi** - Data Scientist, отвечал за очистку данных, парсинг погодных условий (`preproc.py`, `weather_parser.py`) и визуализацию данных в команде с **angelinanana**.
- **angelinanana**
- **petushokok**
- **zoott1c**

Проект разрабатывается в рамках хакатона ЛЦТ и открыт для дальнейшего улучшения.
