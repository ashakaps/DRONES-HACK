# DRONES_HACK

## Краткое описание

Сервис, который будет автоматически обрабатывать статистические данные Росавиации и извлекать из них показатели по количеству и длительности полётов гражданских беспилотников в каждом регионе. Эти показатели помогут определить регионы-лидеры по использованию беспилотных систем.

Задача сервиса – сокращение трудозатрат государственных учреждений на формирование отчетов по полетам БАС (беспилотных авиационных системы) и производимым работам в регионе.

Решение - отдельный сервис, который может стать независимой информационной системой или ее компонентом. Сервис должен работать на операционной системе семейства Linux

## Основные функции

- **Обработка данных полётов**.  Сервис поддерживает импорт статистики по БПЛА из Excel‑файлов (источники 2024 и 2025 годов).  Для каждой записи определяются идентификатор полёта, тип аппарата, координаты взлёта и посадки и плановые/фактические даты и времена вылета/прилёта.  Преобразование выполняется в векторном режиме с использованием заранее скомпилированных регулярных выражений.
- **Очистка и нормализация**.  Во время подготовки данных удаляются дубликаты (уникальность определяется по сочетанию `flight_id` и даты вылета или, при отсутствии идентификатора, по координатам и времени полёта).  Координаты вида `554529N0382503E` преобразуются в десятичные градусы, выполняется коррекция ситуаций со смещением часовых поясов и вычисляется длительность полёта в минутах.
- **Расчёт метрик**.  Для каждого полёта вычисляются продолжительность, пройденная дистанция (по формуле хаверсина), средняя скорость и показатели загруженности региона (отношение количества полётов к площади региона).  Данные обогащаются погодными параметрами (температура, влажность, скорость и направление ветра) и классифицируются по сезонам и времени суток.
- **Загрузка в базу данных**.  Очещённые данные загружаются в PostgreSQL с расширением PostGIS.  Схема базы предусматривает таблицы регионов, типов БПЛА, фактов полётов, геоточек, метрик, погоды и вспомогательных измерений.
- **REST‑API**.  Веб‑сервер на FastAPI предоставляет следующие энд‑точки:
  - `/health` — проверка состояния сервиса.
  - `/geo/regions` и `/geo/cities` — выдача геометрий регионов и городов в формате GeoJSON, полученных напрямую из PostGIS.
  - `/charts/{name}` — генерация графиков (PNG) по заранее определённым сценариям: недельная активность по выбранному городу, суммарная месячная активность и распределение топ‑10 регионов.
  - `/db/status` (см. `app/routes/db.py`) — проверка подключения к базе.
- **Веб‑интерфейс**.  Статические файлы (HTML/JS/CSS) размещены в `app/static`.  Клиент открывает интерактивную карту с использованием Leaflet; пользователи могут выбрать регион или город, просмотреть графики и траектории полётов, а также получить текстовые отчёты.  Запросы к API выполняются через `fetch` внутри JavaScript.  
- **Микросервис прогнозирования**.  Каталог `ml` содержит заготовку сервиса машинного обучения (FastAPI), который в будущем сможет принимать данные и возвращать прогнозы по длительности полёта/нагрузке.  Пока реализованы демонстрационные энд‑точки `ping` и `predict`.

## Архитектура

Проект следует микросервисной архитектуре.  Основные компоненты взаимодействуют следующим образом:

```
 ┌────────────┐      HTTP/REST       ┌───────────────────┐
 │  Frontend  │  ◀──────────────────▶│   API Service     │
 │ (Leaflet)  │                      │   (FastAPI)       │
 └────────────┘                      ├───────────────────┤
        ▲                           │ /health /geo/...  │
        │                           │ /charts/{name}    │
        │                           └─────────▲─────────┘
        │                                       │
        │                                       │asyncpg
        │                                       ▼
 ┌────────────┐                        ┌─────────────────┐
 │  ML Model  │  (планируется)        │    PostGIS DB    │
 │ (FastAPI)  │───HTTP/REST──────────▶│   (PostgreSQL)   │
 └────────────┘                        └─────────────────┘
```

Docker‑композиция (`docker-compose.yml`) описывает три сервиса: веб‑API, микросервис ML и базу данных PostGIS.  API публикует порт `8080`, ML‑сервис — порт `8001`, база данных — `5432`.  Сервис API монтирует исходники (`/app`) и зависит от ML и DB сервисов для корректной работы.

## Структура репозитория

Основные директории и файлы:

| Путь                     | Назначение |
|--------------------------|------------|
| `app/main.py`            | Инициализация FastAPI, настройка CORS и маршрутов |
| `app/routes/geo.py`      | Энд‑точки для получения геоданных о регионах и городах |
| `app/routes/charts.py`   | Энд‑точка для генерации графиков и выдачи путей к файлам PNG |
| `app/static/`            | Фронтенд: HTML/JS/CSS и статические ресурсы |
| `app/charts/`            | Функции построения графиков (например, еженедельная статистика по городу) |
| `database/schema_db.sql` | SQL‑схема базы данных PostGIS |
| `database/load_geojson.py` | Скрипт загрузки геометрии регионов в базу |
| `database/load_all_data.py` | Скрипт импорта полётов и погоды из подготовленных Excel |
| `src/preprocessing.py`   | Нормализация и объединение сырых данных по годам |
| `src/prepoc.py`          | Расширенный предобработчик, обогащающий данные погодой, вычисляющий длительность, дистанцию, скорость и загруженность |
| `ml/`                    | Заготовка микросервиса машинного обучения |
| `docker-compose.yml`     | Описание сервисов Docker |
| `requirements.txt`       | Список зависимостей Python |

## Требования и зависимости

- **ОС**: Linux (Ubuntu 20.04+), Windows или MacOS.  
- **Python**: 3.10 или выше.  
- **PostgreSQL**: ≥ 13 с расширением PostGIS.  
- **Docker**: для развёртывания через `docker-compose` (рекомендуется).

Зависимости Python перечислены в `requirements.txt`: `fastapi`, `uvicorn`, `pydantic`, `asyncpg`, `python-dotenv`, инструменты для работы с данными (`pandas`, `openpyxl`), построения графиков (`matplotlib`, `seaborn`) и работы с базой (`sqlalchemy`, `psycopg-binary`).

## Установка и запуск

### 1. Быстрый старт через Docker

1. Установите Docker и Docker Compose.
2. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/ashakaps/DRONES_HACK.git
   cd DRONES_HACK
   ```

3. Создайте файл `.env` (на основе `.env.example`) и укажите параметры подключения к базе данных, корневой URL‑адрес для CORS и прочие переменные.
4. Запустите сервисы:

   ```bash
   docker-compose up --build
   ```

5. Откройте `http://localhost:8080` в браузере, чтобы увидеть веб‑интерфейс.  
   API будет доступно на `http://localhost:8080`, ML‑сервис — на `http://localhost:8001`.

### 2. Запуск без Docker (для разработки)

1. Установите PostgreSQL с PostGIS и создайте базу `droneradar` (пользователь/пароль по умолчанию — `postgres`).
2. Создайте виртуальное окружение и установите зависимости:

   ```bash
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

3. Создайте файл `.env` со строкой подключения к базе `DATABASE_URL=postgresql://USER:PASSWORD@localhost:5432/droneradar` и другими настройками.
4. Загрузите геоданные и статистику:

   ```bash
   python database/load_geojson.py --regions data/geojson/regions.json
   python database/load_all_data.py --data_file data/data.xlsx
   ```

5. Запустите сервер:

   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port 8080
   ```

6. (Опционально) запустите ML‑сервис в каталоге `ml` аналогичным образом.

## Примеры использования

### Проверка сервиса

```bash
curl http://localhost:8080/health
# → {"status": "ok"}
```

### Получение геоданных

```bash
curl http://localhost:8080/geo/regions
# → {"type": "FeatureCollection", "features": [ … ]}

curl http://localhost:8080/geo/cities
# → {"type": "FeatureCollection", "features": [ … ]}
```

### Получение графиков

```bash
curl "http://localhost:8080/charts/weekly_by_city?city=Москва"
# → {"path": "/static/data/png/weekly_by_city.png"}

curl http://localhost:8080/static/data/png/weekly_by_city.png --output weekly_by_city.png
```

Графики сохраняются в каталоге `app/static/data/png`; их можно отображать напрямую в браузере.  Доступные типы графиков определены в `app/charts` и включают еженедельную активность по выбранному городу, суммарный месячный объём полётов и распределение топ‑10 регионов по количеству полётов.

### Работа с веб‑интерфейсом

После запуска откройте `http://localhost:8080`.  Слева расположена карта России, позволяющая выбрать регион или город.  Справа отображаются графики и сводная информация.  Выбор пункта в таблице маршрутов подсвечивает соответствующую траекторию на карте.  В будущем предполагается добавление загрузки пользовательских файлов и прогнозов от ML‑сервиса.

## Планы развития

В ходе хакатона реализованы ключевые функции по загрузке, очистке и визуализации данных.  В планах дальнейшего развития:

1. **Расширение набора графиков** — добавить диаграммы распределения по типам БПЛА, тепловые карты по времени суток и погодным условиям, а также прогнозные графики.
2. **Интеграция ML‑модуля** — обучить модели для прогнозирования длительности полёта, выявления аномалий и оценки потенциальной загруженности регионов.  Интерфейс `/predict` будет возвращать вероятностные оценки и рекомендации.
3. **Подключение к внешним источникам** — автоматический импорт данных из API Росавиации и метеорологических сервисов, обновление статистики в реальном времени.
4. **Ролевой доступ и аутентификация** — внедрить механизм авторизации (OAuth2/JWT), разграничение прав для операторов и аналитиков, а также логирование действий.
5. **Оптимизация фронтенда** — улучшить пользовательский интерфейс, добавить настройки фильтрации (по дате, региону, типу аппарата), реализовать экспорт отчётов в формате PDF/Excel.

## Команда и вклад

- **ashakaps** — Data Scientist, отвечала предобработку и анализ данных (`preprocessing.py`) в команде с **l00fi**, а также за разработку базы данных, её наполение и оформление документации.
- **l00fi** - Data Scientist, отвечал за очистку данных, парсинг погодных условий (`preprocessing.py`, `weather_parser.py`) и визуализацию данных в команде с **angelinanana**.
